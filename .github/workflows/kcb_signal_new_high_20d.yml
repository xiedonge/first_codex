name: kcb-signal-new-high-20d

on:
  schedule:
    - cron: "40 12 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

env:
  TZ: Asia/Shanghai
  OUT_DIR: data
  PUSH_CHANGES: "true"

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run 20-day new high scan
        run: python kcb_signal_new_high_20d.py --data-dir "${OUT_DIR}/daily" --out "${OUT_DIR}/signals_new_high_20d.csv"
      - name: Upload signals
        uses: actions/upload-artifact@v4
        with:
          name: kcb-signals-new-high-20d-${{ github.run_id }}
          path: ${{ env.OUT_DIR }}/signals_new_high_20d.csv
          if-no-files-found: error
      - name: Commit signals
        if: env.PUSH_CHANGES == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${OUT_DIR}/signals_new_high_20d.csv"
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update 20d new high signals"
            git push
          fi
